---
title: "Weibo COVID Analysis"
date: "2025-03-30"
author: "Yingying Fan, Jinchi Lv, Ao Sun and Yurou Wang"
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = ".")
suppressPackageStartupMessages({
  library(dplyr)
  library(forecast)
  library(MTS)
  library(lubridate)
})
source("./utility.R")
```

```{r}
Top_num <- 20
h_c <- seq(3, 6, 1)
```

```{r}
as_tables <- function(Res_m, h_c) {
  colnames(Res_m) <- c(
    "h",
    "ar_mse",
    "ar_sign",
    "LDA_mse",
    "LDA_sign",
    "LLM_LDA_mse",
    "LLM_LDA_sign"
  )
  row.names(Res_m) <- Res_m[, 1]
  Res_m <- Res_m[, 2:ncol(Res_m)]

  rmse <- as.data.frame(Res_m[, seq(1, ncol(Res_m), 2), drop = FALSE])
  sign <- as.data.frame(Res_m[, seq(2, ncol(Res_m), 2), drop = FALSE])
  colnames(rmse) <- c("AR", "LDA", "LLM_LDA")
  colnames(sign) <- c("AR", "LDA", "LLM_LDA")

  list(
    rmse = data.frame(H = h_c, rmse, check.names = FALSE),
    sign = data.frame(H = h_c, sign, check.names = FALSE)
  )
}
```



```{r}
df <- read.csv("3year_meanTopic20Distri_mergeCPI_df19-21_20250314.csv")
Top_num <- 20
df_new <- df[, c(1, 3, 7:(Top_num + 6))]
df_new$unem <- df[[4]]
df_new$cpi <- df$cpi_lastmonth_100
df_new$time <- as.Date(df_new$time)
df_new <- df_new %>%
  arrange(time)

df_new <- df_new %>%
  mutate(
    month = format(time, "%Y-%m"),
    day = day(time),
    period = case_when(
      day <= 10 ~ "up",
      day <= 20 ~ "middle",
      TRUE ~ "down"
    )
  )

df_new <- df_new[, !names(df_new) %in% c("time")]
df_summary <- df_new %>%
  group_by(month, period) %>%
  summarise(across(everything(), mean, na.rm = TRUE))

y_m_list <- sort(unique(df_summary$month))
tilde_y_m <- matrix(ncol = 3, nrow = length(y_m_list))
for (i in 1:length(y_m_list)) {
  res_ym <- y_m_list[i]
  tilde_y_m[i, ] <- df_summary[df_summary$month == res_ym, ]$pred_scoreInflation
}

tilde_y_m <- scale(tilde_y_m - 0.5, center = FALSE)

X_m <- matrix(ncol = Top_num, nrow = length(y_m_list))
for (i in 1:length(y_m_list)) {
  res_ym <- y_m_list[i]
  X_m[i, ] <- apply(df_summary[df_summary$month == res_ym, 4:(Top_num + 3)], 2, mean)
}
X_m <- scale(X_m, scale = FALSE)

y_df <- df_new %>%
  group_by(month) %>%
  summarise(y = mean(cpi))
y <- y_df$y
y <- y - 100
y <- scale(y, center = FALSE)

h_c <- seq(3, 6, 1)
rank_c <- NULL
for (k in 1:length(h_c)) {
  h <- h_c[k]
  test_idx <- (length(y) - h + 1):length(y)
  obs_idx <- setdiff(1:length(y), test_idx)
  ar_fit <- auto.arima(
    y[obs_idx],
    max.q = 0,
    D = 0,
    seasonal = FALSE,
    allowmean = FALSE,
    allowdrift = FALSE
  )
  ar_fit <- arima(y[obs_idx], order = c(ar_fit$arma[1], 0, 0), include.mean = FALSE)

  mse_c <- NULL
  for (i in 1:Top_num) {
    strong_idx <- order(abs(cov(ar_fit$residuals, X_m[obs_idx, ])), decreasing = TRUE)[1:i]
    arx_fit <- arima(
      y[obs_idx],
      order = c(ar_fit$arma[1], 0, 0),
      xreg = X_m[obs_idx, strong_idx],
      include.mean = FALSE
    )
    arx_predictions <- predict(
      arx_fit,
      n.ahead = h,
      newxreg = X_m[test_idx, strong_idx]
    )$pred

    mse_c[i] <- mean((arx_predictions - y[test_idx])^2)
  }
  rank_c[k] <- which.min(mse_c)
}

num_topic <- as.numeric(names(which.max(table(rank_c))))
strong_idx <- order(abs(cov(ar_fit$residuals, X_m[obs_idx, ])), decreasing = TRUE)[1:num_topic]

Res_m <- matrix(nrow = length(h_c), ncol = 7)
for (k in 1:length(h_c)) {
  h <- h_c[k]
  res_c <- NULL
  test_idx <- (length(y) - h + 1):length(y)
  obs_idx <- setdiff(1:length(y), test_idx)

  ar_fit <- auto.arima(
    y[obs_idx],
    max.q = 0,
    D = 0,
    seasonal = FALSE,
    allowmean = FALSE,
    allowdrift = FALSE
  )
  ar_fit <- arima(y[obs_idx], order = c(ar_fit$arma[1], 0, 0), include.mean = FALSE)
  ar_prediction <- predict(ar_fit, n.ahead = h)$pred

  res_c <- c(res_c, mean((ar_prediction - y[test_idx])^2))
  res_c <- c(res_c, mean(sign(ar_prediction) != sign(y[test_idx])))

  arx_fit <- arima(
    y[obs_idx],
    order = c(ar_fit$arma[1], 0, 0),
    xreg = X_m[obs_idx, strong_idx],
    include.mean = FALSE
  )
  arx_predictions <- predict(
    arx_fit,
    n.ahead = h,
    newxreg = X_m[test_idx, strong_idx]
  )$pred

  res_c <- c(res_c, mean((arx_predictions - y[test_idx])^2))
  res_c <- c(res_c, mean(sign(arx_predictions) != sign(y[test_idx])))

  p1 <- ar_fit$arma[1]
  p2 <- 1
  powered_prediction <- Prediction_powered_ts(
    X_m,
    y,
    tilde_y_m,
    p1,
    p2,
    obs_idx,
    test_idx,
    strong_idx,
    h
  )

  res_c <- c(res_c, mean((powered_prediction - y[test_idx])^2))
  res_c <- c(res_c, mean(sign(powered_prediction) != sign(y[test_idx])))
  Res_m[k, ] <- c(h, res_c)
}

tables_1921 <- as_tables(Res_m, h_c)
```

```{r results='asis'}
cat("Selected topics: ", paste(strong_idx, collapse = ", "), "\n\n")
print(knitr::kable(tables_1921$rmse, digits = 3, caption = "RMSE (2019-2021)"))
print(knitr::kable(tables_1921$sign, digits = 3, caption = "Sign mismatch (2019-2021)"))
rmse_avg_1921 <- data.frame(
  Metric = "Average (H=2..6)",
  colMeans(tables_1921$rmse[, -1, drop = FALSE], na.rm = TRUE),
  check.names = FALSE
)
sign_avg_1921 <- data.frame(
  Metric = "Average (H=2..6)",
  colMeans(tables_1921$sign[, -1, drop = FALSE], na.rm = TRUE),
  check.names = FALSE
)
print(knitr::kable(rmse_avg_1921, digits = 3, caption = "Average RMSE (2019-2021)"))
print(knitr::kable(sign_avg_1921, digits = 3, caption = "Average Sign mismatch (2019-2021)"))
```



```{r}
df <- read.csv("3year_meanTopic20Distri_mergeCPI_df21-23_20250314.csv")
Top_num <- 20
df_new <- df[, c(1, 3, 7:(Top_num + 6))]
df_new$unem <- df[[4]]
df_new$cpi <- df$cpi_lastmonth_100
df_new$time <- as.Date(df_new$time)
df_new <- df_new %>%
  arrange(time)

df_new <- df_new %>%
  mutate(
    month = format(time, "%Y-%m"),
    day = day(time),
    period = case_when(
      day <= 10 ~ "up",
      day <= 20 ~ "middle",
      TRUE ~ "down"
    )
  )

df_new <- df_new[, !names(df_new) %in% c("time")]
df_summary <- df_new %>%
  group_by(month, period) %>%
  summarise(across(everything(), mean, na.rm = TRUE))

y_m_list <- sort(unique(df_summary$month))
tilde_y_m <- matrix(ncol = 3, nrow = length(y_m_list))
for (i in 1:length(y_m_list)) {
  res_ym <- y_m_list[i]
  tilde_y_m[i, ] <- df_summary[df_summary$month == res_ym, ]$pred_scoreInflation
}

tilde_y_m <- scale(tilde_y_m - 0.5, center = FALSE)

X_m <- matrix(ncol = Top_num, nrow = length(y_m_list))
for (i in 1:length(y_m_list)) {
  res_ym <- y_m_list[i]
  X_m[i, ] <- apply(df_summary[df_summary$month == res_ym, 4:(Top_num + 3)], 2, mean)
}
X_m <- scale(X_m, scale = FALSE)

y_df <- df_new %>%
  group_by(month) %>%
  summarise(y = mean(cpi))
y <- y_df$y
y <- y - 100
y <- scale(y, center = FALSE)

h_c <- seq(3, 6, 1)
rank_c <- NULL
for (k in 1:length(h_c)) {
  h <- h_c[k]
  test_idx <- (length(y) - h + 1):length(y)
  obs_idx <- setdiff(1:length(y), test_idx)
  ar_fit <- auto.arima(
    y[obs_idx],
    max.q = 0,
    D = 0,
    seasonal = FALSE,
    allowmean = FALSE,
    allowdrift = FALSE
  )
  ar_fit <- arima(y[obs_idx], order = c(ar_fit$arma[1], 0, 0), include.mean = FALSE)

  mse_c <- NULL
  for (i in 1:Top_num) {
    strong_idx <- order(abs(cor(ar_fit$residuals, X_m[obs_idx, ])), decreasing = TRUE)[1:i]
    arx_fit <- arima(
      y[obs_idx],
      order = c(ar_fit$arma[1], 0, 0),
      xreg = X_m[obs_idx, strong_idx],
      include.mean = FALSE
    )
    arx_predictions <- predict(
      arx_fit,
      n.ahead = h,
      newxreg = X_m[test_idx, strong_idx]
    )$pred

    mse_c[i] <- mean((arx_predictions - y[test_idx])^2)
  }
  rank_c[k] <- which.min(mse_c)
}

num_topic <- as.numeric(names(which.max(table(rank_c))))
strong_idx <- order(abs(cor(ar_fit$residuals, X_m[obs_idx, ])), decreasing = TRUE)[1:num_topic]

Res_m <- matrix(nrow = length(h_c), ncol = 7)
for (k in 1:length(h_c)) {
  h <- h_c[k]
  res_c <- NULL
  test_idx <- (length(y) - h + 1):length(y)
  obs_idx <- setdiff(1:length(y), test_idx)

  ar_fit <- auto.arima(
    y[obs_idx],
    max.q = 0,
    D = 0,
    seasonal = FALSE,
    allowmean = FALSE,
    allowdrift = FALSE
  )
  ar_fit <- arima(y[obs_idx], order = c(ar_fit$arma[1], 0, 0), include.mean = FALSE)
  ar_prediction <- predict(ar_fit, n.ahead = h)$pred

  res_c <- c(res_c, mean((ar_prediction - y[test_idx])^2))
  res_c <- c(res_c, mean(sign(ar_prediction) != sign(y[test_idx])))

  arx_fit <- arima(
    y[obs_idx],
    order = c(ar_fit$arma[1], 0, 0),
    xreg = X_m[obs_idx, strong_idx],
    include.mean = FALSE
  )
  arx_predictions <- predict(
    arx_fit,
    n.ahead = h,
    newxreg = X_m[test_idx, strong_idx]
  )$pred

  res_c <- c(res_c, mean((arx_predictions - y[test_idx])^2))
  res_c <- c(res_c, mean(sign(arx_predictions) != sign(y[test_idx])))

  p1 <- ar_fit$arma[1]
  p2 <- 1
  powered_prediction <- Prediction_powered_ts(
    X_m,
    y,
    tilde_y_m,
    p1,
    p2,
    obs_idx,
    test_idx,
    strong_idx,
    h
  )

  res_c <- c(res_c, mean((powered_prediction - y[test_idx])^2))
  res_c <- c(res_c, mean(sign(powered_prediction) != sign(y[test_idx])))
  Res_m[k, ] <- c(h, res_c)
}

tables_2123 <- as_tables(Res_m, h_c)
```

```{r results='asis'}
cat("Selected topics: ", paste(strong_idx, collapse = ", "), "\n\n")
print(knitr::kable(tables_2123$rmse, digits = 3, caption = "RMSE (2021-2023)"))
print(knitr::kable(tables_2123$sign, digits = 3, caption = "Sign mismatch (2021-2023)"))
rmse_avg_2123 <- data.frame(
  Metric = "Average (H=2..6)",
  colMeans(tables_2123$rmse[, -1, drop = FALSE], na.rm = TRUE),
  check.names = FALSE
)
sign_avg_2123 <- data.frame(
  Metric = "Average (H=2..6)",
  colMeans(tables_2123$sign[, -1, drop = FALSE], na.rm = TRUE),
  check.names = FALSE
)
print(knitr::kable(rmse_avg_2123, digits = 3, caption = "Average RMSE (2021-2023)"))
print(knitr::kable(sign_avg_2123, digits = 3, caption = "Average Sign mismatch (2021-2023)"))
```
