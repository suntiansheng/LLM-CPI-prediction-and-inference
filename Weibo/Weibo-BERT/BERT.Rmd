---
title: "BERT Embedding Real Data Analysis"
date: "2025-12-01"
author: "Yingying Fan, Jinchi Lv, Ao Sun and Yurou Wang"
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("./utility.R")
library(lubridate)
set.seed(2025)
setwd("/Users/sunao/Desktop/LLM-TS-Revision/code/real_data/Weibo-final/")

Average_prediction <- function(y, H) {
  sapply(seq_len(H), function(h) mean(tail(y, h)))
}

check_coverage <- function(interval_row, true_val) {
  as.integer(true_val >= interval_row[1] & true_val <= interval_row[2])
}
```


```{r}

df <- read.csv("./bert_final.csv")
```


```{r}

topic_cols <- names(df)[grepl("^X\\d+$|^\\d+$", names(df))]
stopifnot("No topic columns found" = length(topic_cols) > 0)
unem_col <- "unem"
has_unem <- TRUE


df_new <- df %>%
  mutate(
    time = as.Date(time),
    unem = .data[[unem_col]],
    cpi = cpi_lastmonth_100,
    month = format(time, "%Y-%m"),
    day = lubridate::day(time),
    period = case_when(
      day <= 10 ~ "up",
      day <= 20 ~ "middle",
      TRUE ~ "down"
    )
  ) %>%
  select(month, period, aveScore, all_of(topic_cols), unem, cpi)


df_summary <- df_new %>%
  group_by(month, period) %>%
  summarise(across(everything(), ~ mean(.x, na.rm = TRUE)), .groups = "drop")

y_m_list <- sort(unique(df_summary$month))
month_dates <- as.Date(paste0(y_m_list, "-01"))


topic_cols_summary <- intersect(topic_cols, names(df_summary))
X_m <- df_summary %>%
  group_by(month) %>%
  summarise(across(all_of(topic_cols_summary), ~ mean(.x, na.rm = TRUE)), .groups = "drop") %>%
  arrange(month) %>%
  select(-month) %>%
  as.matrix()

X_m <- scale(X_m)

y <- df_new %>%
  group_by(month) %>%
  summarise(y = mean(cpi, na.rm = TRUE), .groups = "drop") %>%
  arrange(month) %>%
  pull(y)

y <- scale(y - 100)


y_m_list <- sort(unique(df_summary$month))
tilde_y_m <- matrix(ncol = 3, nrow = length(y_m_list))
for(i in seq_along(y_m_list)){
  res_ym <- y_m_list[i]
  tilde_y_m[i,] <- df_summary[df_summary$month == res_ym, "aveScore", drop = TRUE]
}

unem <- df_new %>%
  group_by(month) %>%
  summarise(y = mean(unem, na.rm = TRUE), .groups = "drop") %>%
  arrange(month) %>%
  pull(y)
unem <- scale(unem)

```




```{r}

EOD <- max(which(month_dates < as.Date("2024-07-01")))
sel <- tryCatch(select_topics(y, X_m, train_idx = 1:EOD, use_cor = FALSE, penalty_w = 0.1),
                error = function(e) list(selected = character()))
strong_idx <- match(sel$selected, colnames(X_m))
strong_idx <- strong_idx[!is.na(strong_idx)]
strong_idx
```



```{r}
h_pred <- seq(8,15,1)
Res_m <- matrix(nrow = length(h_pred), ncol = 16)
for(k in seq_along(h_pred)){
  h <- h_pred[k]
  res_c <- NULL
  test_idx <- (length(y) - h + 1):length(y)
  obs_idx <- setdiff(seq_along(y), test_idx)


  ar_base <- tryCatch(auto.arima(y[obs_idx],max.q = 0, D = 0,seasonal = FALSE, allowmean = FALSE, allowdrift = FALSE),
                      error = function(e) list(arma = c(1,0,0)))
  ar_fit <- arima(y[obs_idx], order = c(ar_base$arma[1],0,0), include.mean = FALSE)
  ar_prediction <- predict(ar_fit, n.ahead = h)$pred
  res_c <- c(res_c, sqrt(mean((ar_prediction-y[test_idx])^2)))
  res_c <- c(res_c, mean(sign(ar_prediction) !=sign(y[test_idx])))


  mean_prediction <- rep(y[max(obs_idx)], length(test_idx))
 res_c <- c(res_c, sqrt(mean((mean_prediction-y[test_idx])^2)))
  res_c <- c(res_c, mean(sign(mean_prediction) !=sign(y[test_idx])))


  ave_prediction <- Average_prediction(y[obs_idx], length(test_idx))
  res_c <- c(res_c, sqrt(mean((ave_prediction-y[test_idx])^2)))
  res_c <- c(res_c, mean(sign(ave_prediction) !=sign(y[test_idx])))


  ar_unem_base <- tryCatch(auto.arima(y[obs_idx], xreg = unem[obs_idx], max.q = 0, D = 0,seasonal = FALSE, allowmean = FALSE,      allowdrift = FALSE),
                           error = function(e) list(arma = c(1,0,0)))
  ar_unem_fit <- arima(y[obs_idx], xreg = unem[obs_idx], order = c(ar_unem_base$arma[1],0,0), include.mean = FALSE)
  ar_unem_prediction <- predict(ar_unem_fit, newxreg = unem[test_idx], n.ahead = h)$pred

  res_c <- c(res_c, sqrt(mean((ar_unem_prediction-y[test_idx])^2)))
  res_c <- c(res_c, mean(sign(ar_unem_prediction) !=sign(y[test_idx])))


  arx_fit <- arima(y[obs_idx], order = c(ar_base$arma[1],0,0), xreg = X_m[obs_idx,strong_idx, drop = FALSE], include.mean = FALSE)
  arx_predictions <- predict(arx_fit, n.ahead = h, newxreg = X_m[test_idx,strong_idx, drop = FALSE])$pred

  res_c <- c(res_c, sqrt(mean((arx_predictions-y[test_idx])^2)))
  res_c <- c(res_c, mean(sign(arx_predictions) !=sign(y[test_idx])))


  arx_unem_fit <- arima(y[obs_idx],order = c(max(1, ar_base$arma[1]),0,0), xreg = cbind(X_m[obs_idx,strong_idx, drop=FALSE],unem[obs_idx]),    include.mean = FALSE)
  arx_unem_predictions <-predict(arx_unem_fit, n.ahead=h, newxreg=cbind(X_m[test_idx,strong_idx,drop=FALSE],  unem[test_idx]))$pred

  res_c <- c(res_c, sqrt(mean((arx_unem_predictions-y[test_idx])^2)))
  res_c <- c(res_c, mean(sign(arx_unem_predictions) !=sign(y[test_idx])))


  p1=ar_base$arma[1]
  p2=1

  powered_prediction <- LLM_TS.Predict(X_m, y, tilde_y_m, p1, p2, obs_idx, test_idx, strong_idx, h)

  res_c <- c(res_c, sqrt(mean((powered_prediction-y[test_idx])^2)))
  res_c <- c(res_c, mean(sign(powered_prediction) !=sign(y[test_idx])))


  powered_unem_prediction <- LLM_TS.Predict(cbind(X_m,unem), y, tilde_y_m, p1, p2, obs_idx, test_idx,
                                            c(strong_idx,ncol(X_m)+1), h)


  res_c <- c(res_c, sqrt(mean((powered_unem_prediction-y[test_idx])^2)))
  res_c <- c(res_c, mean(sign(powered_unem_prediction) !=sign(y[test_idx])))
  Res_m[k,] <- res_c
}
```

```{r}
BERT_mse <- Res_m[,c(1,3,5,7,9,11,13,15)]
BERT_sign <- Res_m[,c(2,4,6,8,10,12,14,16)]
colnames(BERT_mse) <- c('AR','RW','AVE','AR+unem','BERT','BERT+unem','LLM+BERT','LLM+BERT+unem')
colnames(BERT_sign) <- c('AR','RW','AVE','AR+unem','BERT','BERT+unem','LLM+BERT','LLM+BERT+unem')
```




```{r}
h_pi <- seq(8,15,1)

source("./SPI.R")

coverage_m <- matrix(NA, nrow = length(h_pi), ncol = 10)
len_m <- matrix(NA, nrow = length(h_pi), ncol = 10)

for(k in seq_along(h_pi)){
  h <- h_pi[k]

  test_idx <- (length(y) - h + 1):length(y)
  obs_idx <- setdiff(seq_along(y), test_idx)


  ar_base <- tryCatch(auto.arima(y[obs_idx], max.q = 0, D = 0, seasonal = FALSE, allowmean = FALSE, allowdrift = FALSE),
                      error = function(e) list(arma = c(1,0,0)))
  ar_fit <- Arima(y[obs_idx], order = c(ar_base$arma[1],0,0),include.mean = FALSE)
  ar_predictions_fit <- forecast(ar_fit, h = length(test_idx))
  ar_interval <- cbind(ar_predictions_fit$lower[,2], ar_predictions_fit$upper[,2])
  len_m[k, 1] <- mean(as.numeric(ar_interval[,2] - ar_interval[,1]))
  coverage_m[k,1] <- mean(mapply(check_coverage, split(ar_interval, row(ar_interval)), y[test_idx]))


  if (has_unem) {
    ar_unem_fit <- Arima(y[obs_idx], order = c(ar_base$arma[1],0,0), xreg = unem[obs_idx], include.mean = FALSE)
    ar_unem_predictions_fit <- forecast(ar_unem_fit, h = length(test_idx), xreg = unem[test_idx])
    ar_unem_interval <- cbind(ar_unem_predictions_fit$lower[,2], ar_unem_predictions_fit$upper[,2])
    len_m[k, 2] <- mean(as.numeric(ar_unem_interval[,2] - ar_unem_interval[,1]))
    coverage_m[k,2] <- mean(mapply(check_coverage, split(ar_unem_interval, row(ar_unem_interval)), y[test_idx]))
  } else {
    len_m[k,2] <- NA
    coverage_m[k,2] <- NA
  }





  arx_BERT_fit <- Arima(y[obs_idx], order = c(ar_base$arma[1],0,0), xreg = X_m[obs_idx,strong_idx,drop = FALSE], include.mean = FALSE)
  arx_BERT_predictions_fit <- forecast(arx_BERT_fit, h = length(test_idx), xreg = X_m[test_idx,strong_idx,drop = FALSE])
  arx_BERT_interval <- cbind(arx_BERT_predictions_fit$lower[,2], arx_BERT_predictions_fit$upper[,2])

  len_m[k,3] <- mean(arx_BERT_interval[,2] - arx_BERT_interval[,1])
  coverage_m[k,3] <- mean(mapply(check_coverage, split(arx_BERT_interval, row(arx_BERT_interval)), y[test_idx]))


  if (has_unem) {
     arx_BERT_un_fit <- Arima(y[obs_idx], order = c(ar_fit$arma[1],0,0), xreg = cbind(X_m[obs_idx,strong_idx, drop=FALSE], unem[obs_idx]), include.mean = FALSE)
    arx_BERT_un_predictions_fit <- forecast(arx_BERT_un_fit, h = length(test_idx), xreg = cbind(X_m[test_idx,strong_idx,drop=FALSE], unem[test_idx]))
    arx_BERT_un_interval <- cbind(arx_BERT_un_predictions_fit$lower[,2], arx_BERT_un_predictions_fit$upper[,2])

    len_m[k,4] <- mean(arx_BERT_un_interval[,2] - arx_BERT_un_interval[,1])
    coverage_m[k,4] <- mean(mapply(check_coverage, split(arx_BERT_un_interval, row(arx_BERT_un_interval)), y[test_idx]))
  } else {
    len_m[k,4] <- NA
    coverage_m[k,4] <- NA
  }


  p1=ar_base$arma[1]
  p2=1
  powered_BERT_interval <- LLM_TS.BJ(X_m, y, tilde_y_m, p1, p2, obs_idx, test_idx,
                                            strong_idx, h)$interval
  len_m[k,5] <- mean(powered_BERT_interval[,2] - powered_BERT_interval[,1])
  coverage_m[k,5] <- mean(mapply(check_coverage, split(powered_BERT_interval, row(powered_BERT_interval)), y[test_idx]))


  boot_BERT_interval <- LLM_TS.BOOT(X_m, y, tilde_y_m, p1, p2, obs_idx, test_idx, strong_idx, h, B=2000)$interval

  len_m[k,6] <- mean(boot_BERT_interval[,2] - boot_BERT_interval[,1])
  coverage_m[k,6] <- mean(mapply(check_coverage, split(boot_BERT_interval, row(boot_BERT_interval)), y[test_idx]))



  if (has_unem) {
    powered_interval <- LLM_TS.BJ(cbind(X_m,unem), y, tilde_y_m, p1, p2, obs_idx, test_idx,
                                      c(strong_idx,ncol(X_m)+1), h)$interval
    len_m[k,7] <- mean(powered_interval[,2] - powered_interval[,1])
    coverage_m[k,7] <- mean(mapply(check_coverage, split(powered_interval, row(powered_interval)), y[test_idx]))
  } else {
    len_m[k,7] <- NA
    coverage_m[k,7] <- NA
  }



  if (has_unem) {
    boot_interval <- LLM_TS.BOOT(cbind(X_m,unem), y, tilde_y_m, p1, p2, obs_idx, test_idx, c(strong_idx,ncol(X_m)+1), h, B = 2000)$interval

    len_m[k,8] <- mean(boot_interval[,2] - boot_interval[,1])
    coverage_m[k,8] <- mean(mapply(check_coverage, split(boot_interval, row(boot_interval)), y[test_idx]))
  } else {
    len_m[k,8] <- NA
    coverage_m[k,8] <- NA
  }
}

```

```{r}
spi_res <- spi_multi_horizon(
  y = y,
  X_m = X_m,
  tilde_y_m = tilde_y_m,
  strong_idx = strong_idx,
  h_vec = h_pi,
  unem = unem,
  has_unem = has_unem,
  cal_frac = 0.2,
  alpha = 0.05,
  p2 = 1
)

coverage_m[,9] <- spi_res$coverage_without_unem
len_m[,9] <- spi_res$length_without_unem
coverage_m[,10] <- spi_res$coverage_with_unem
len_m[,10] <- spi_res$length_with_unem
```

```{r}
BERT_cov <- coverage_m
colnames(BERT_cov) <- c('AR','AR+unem','BERT', 'BERT+unem', 'LLM+BERT(BJ)','LLM+BERT(Boot)','LLM+BERT+unem(BJ)','LLM+BERT+unem(Boot)','LLM+BERT(SPI)','LLM+BERT+unem(SPI)')
BERT_len <- len_m
colnames(BERT_len) <- c('AR','AR+unem','BERT', 'BERT+unem', 'LLM+BERT(BJ)','LLM+BERT(Boot)','LLM+BERT+unem(BJ)','LLM+BERT+unem(Boot)','LLM+BERT(SPI)','LLM+BERT+unem(SPI)')
```




```{r}
MSE_without_unem <- BERT_mse[,c('AR','RW','AVE','BERT','LLM+BERT')]
rMSE_without_unem <- sweep(MSE_without_unem, 1, MSE_without_unem[,'AR',drop=FALSE], "/")
rMSE_without_unem <- cbind(h_pred, rMSE_without_unem)
knitr::kable(rMSE_without_unem,col.names = c('H','AR','RW','AVE','BERT','LLM+BERT'), digits = 3, caption = 'Cumulative rPMSE without unemployment rate')
colMeans(rMSE_without_unem[,-1, drop = FALSE])
```



```{r}
Sign_without_unem <- BERT_sign[,c('AR','RW','AVE','BERT','LLM+BERT')]
rSign_without_unem <- sweep(Sign_without_unem, 1, Sign_without_unem[,'AR',drop=FALSE], "/")
rSign_without_unem <- cbind(h_pred, rSign_without_unem)
knitr::kable(rSign_without_unem,col.names = c('H','AR','RW','AVE','BERT','LLM+BERT'), digits = 3, caption = 'Cumulative rSign without unemployment rate')
colMeans(rSign_without_unem[,-1, drop = FALSE])
```


```{r}
MSE_with_unem <- BERT_mse[,c('AR+unem','RW','AVE','BERT+unem','LLM+BERT+unem')]
rMSE_with_unem <- sweep(MSE_with_unem, 1, MSE_with_unem[,'AR+unem',drop=FALSE], "/")
rMSE_with_unem <- cbind(h_pred, rMSE_with_unem)
knitr::kable(rMSE_with_unem,col.names = c('H','AR+unem','RW','AVE','BERT+unem','LLM+BERT+unem'), digits = 3, caption = 'Cumulative rPMSE with unemployment rate')
colMeans(rMSE_with_unem[,-1, drop = FALSE])
```


```{r}
Sign_with_unem <- BERT_sign[,c('AR+unem','RW','AVE','BERT+unem','LLM+BERT+unem')]
rSign_with_unem <- sweep(Sign_with_unem, 1, Sign_with_unem[,'AR+unem',drop=FALSE], "/")
rSign_with_unem <- cbind(h_pred, rSign_with_unem)
knitr::kable(rSign_with_unem,col.names = c('H','AR+unem','RW','AVE','BERT+unem','LLM+BERT+unem'), digits = 3, caption = 'Cumulative rSign with unemployment rate')
colMeans(rSign_with_unem[,-1, drop = FALSE])
```





```{r}
Cov_without_unem <- BERT_cov[,c('AR','BERT','LLM+BERT(BJ)','LLM+BERT(Boot)','LLM+BERT(SPI)')]
Cov_without_unem <- cbind(h_pi, Cov_without_unem)
knitr::kable(Cov_without_unem, col.names = c('H','AR','BERT','LLM+BERT(BJ)','LLM+BERT(Boot)','LLM+BERT(SPI)'), digits = 3, caption = 'Coverage rate without unemployment rate')
```


```{r}
Len_without_unem <- BERT_len[,c('AR','BERT','LLM+BERT(BJ)','LLM+BERT(Boot)','LLM+BERT(SPI)')]
Len_without_unem <- cbind(h_pi, Len_without_unem)
knitr::kable(Len_without_unem, col.names = c('H','AR','BERT','LLM+BERT(BJ)','LLM+BERT(Boot)','LLM+BERT(SPI)'), digits = 3, caption = 'Interval length without unemployment rate')
```


```{r}
Cov_with_unem <- BERT_cov[,c('AR+unem','BERT+unem','LLM+BERT+unem(BJ)','LLM+BERT+unem(Boot)','LLM+BERT+unem(SPI)')]
Cov_with_unem <- cbind(h_pi, Cov_with_unem)
knitr::kable(Cov_with_unem, col.names = c('H','AR+unem','BERT+unem','LLM+BERT+unem(BJ)','LLM+BERT+unem(Boot)','LLM+BERT+unem(SPI)'), digits = 3, caption = 'Coverage rate with unemployment rate')
```

```{r}
Len_with_unem <- BERT_len[,c('AR+unem','BERT+unem','LLM+BERT+unem(BJ)','LLM+BERT+unem(Boot)','LLM+BERT+unem(SPI)')]
Len_with_unem <- cbind(h_pi, Len_with_unem)
knitr::kable(Len_with_unem, col.names = c('H','AR+unem','BERT+unem','LLM+BERT+unem(BJ)','LLM+BERT+unem(Boot)','LLM+BERT+unem(SPI)'), digits = 3, caption = 'Interval length with unemployment rate')
```
