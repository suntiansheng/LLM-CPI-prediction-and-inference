---
title: "WSJ Robust MSE with LDA Embedding"
date: "2025-12-22"
author: "Yingying Fan, Jinchi Lv, Ao Sun and Yurou Wang"
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
params:
  target_var: "CPIMEDSL"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r load-libs}
suppressPackageStartupMessages({
  library(dplyr)
  library(lubridate)
  library(ggplot2)
  library(jsonlite)
})

source("./utility.R")
```

```{r params}
h <- 12
topic_file <- "./topics_with_pred_score.csv"
price_stock_targets <- c(
  "WPSFD49207", "WPSFD49502", "PPICMM", "CPIAUCSL", "CPIAPPSL", "CPITRNSL",
  "CPIMEDSL", "CUSR0000SAC", "CUSR0000SAD", "CUSR0000SAS", "CPIULFSL",
  "CUSR0000SA0L2", "CUSR0000SA0L5", "PCEPI", "DNDGRG3M086SBEA",
  "DSERRG3M086SBEA", "DDURRG3M086SBEA", "OILPRICEx", "WPSID61", "WPSID62",
  "S&P 500", "S&P div yield", "VIXCLSx"
)
```

```{r helpers}
safe_select <- function(y, X, train_idx, penalties = c(1, 0.5, 0.1)) {
  for (p in penalties) {
    res <- tryCatch(select_topics(y, X, train_idx = train_idx, penalty_w = p),
                    error = function(e) NULL)
    if (!is.null(res) && length(res$selected)) return(res$selected)
  }
  character()
}

make_ratio <- function(x) {
  if (length(x) == 0) return(numeric())
  c(1, x[-1] / x[-length(x)])
}

read_nf_pred <- function(index, h, model) {
  path <- file.path("nf_results", paste0(index, "_h", h, ".json"))
  if (!file.exists(path)) return(NULL)
  payload <- tryCatch(jsonlite::fromJSON(path), error = function(e) NULL)
  if (is.null(payload) || is.null(payload$results)) return(NULL)
  if (!model %in% names(payload$results)) return(NULL)
  pred <- payload$results[[model]]$pred
  if (is.null(pred)) return(NULL)
  as.numeric(pred)
}

read_nf_metrics <- function(index, h, model) {
  path <- file.path("nf_results", paste0(index, "_h", h, ".json"))
  if (!file.exists(path)) return(list(rmse = NA_real_, sign_mismatch = NA_real_))
  payload <- tryCatch(jsonlite::fromJSON(path), error = function(e) NULL)
  if (is.null(payload) || is.null(payload$results)) return(list(rmse = NA_real_, sign_mismatch = NA_real_))
  if (!model %in% names(payload$results)) return(list(rmse = NA_real_, sign_mismatch = NA_real_))
  res <- payload$results[[model]]
  list(
    rmse = if (!is.null(res$rmse)) as.numeric(res$rmse) else NA_real_,
    sign_mismatch = if (!is.null(res$sign_mismatch)) as.numeric(res$sign_mismatch) else NA_real_
  )
}
```

```{r load-data}
macro_raw <- read.csv("./2025-10-MD.csv", stringsAsFactors = FALSE, check.names = FALSE)
macro_raw$sasdate <- suppressWarnings(as.Date(macro_raw[[1]], format = "%m/%d/%Y"))
macro_raw <- macro_raw[!is.na(macro_raw$sasdate), ]

topics_df <- read.csv(topic_file)

df <- topics_df %>%
  mutate(date = as.Date(date)) %>%
  filter(date < as.Date("2025-09-01"), date > as.Date("2015-08-31")) %>%
  arrange(date) %>%
  mutate(
    month = format(date, "%Y-%m"),
    day = day(date),
    period = case_when(
      day <= 10 ~ "up",
      day <= 20 ~ "middle",
      TRUE ~ "down"
    )
  )

df_summary <- df %>%
  group_by(month, period) %>%
  summarise(across(everything(), \(x) mean(x, na.rm = TRUE)), .groups = "drop")

y_m_list <- sort(unique(df_summary$month))
tilde_y_m <- matrix(ncol = 3, nrow = length(y_m_list))
for (i in seq_along(y_m_list)) {
  res_ym <- y_m_list[i]
  tilde_y_m[i, ] <- df_summary[df_summary$month == res_ym, ]$pred_score
}

topic_cols <- names(df_summary)[grepl("^topic", names(df_summary))]
X_m <- matrix(ncol = length(topic_cols), nrow = length(y_m_list))
for (i in seq_along(y_m_list)) {
  res_ym <- y_m_list[i]
  X_m[i, ] <- apply(df_summary[df_summary$month == res_ym, topic_cols], 2, mean)
}
X_m <- scale(X_m)
colnames(X_m) <- topic_cols

topic_dates <- df$date
topic_months <- df$month
unrate_monthly <- df %>%
  group_by(month) %>%
  summarise(unrate = mean(UNRATE, na.rm = TRUE), .groups = "drop") %>%
  filter(month %in% y_m_list)
unrate_vec <- scale(unrate_monthly$unrate)
```

```{r compute}
results <- list()
wins <- 0
total <- 0

for (col_name in price_stock_targets) {
  if (!col_name %in% names(macro_raw)) next
  if (!is.numeric(macro_raw[[col_name]])) next

  m_dates <- macro_raw$sasdate
  m_vals <- macro_raw[[col_name]]
  ptr <- 1
  current <- NA_real_
  target_series <- numeric(length(topic_dates))
  for (i in seq_along(topic_dates)) {
    t_d <- topic_dates[i]
    while (ptr <= length(m_dates) && m_dates[ptr] <= t_d) {
      current <- m_vals[ptr]
      ptr <- ptr + 1
    }
    target_series[i] <- current
  }

  y_df <- data.frame(month = topic_months, y = target_series) %>%
    group_by(month) %>%
    summarise(y = mean(y, na.rm = TRUE), .groups = "drop") %>%
    filter(month %in% y_m_list)
  y_raw <- y_df$y
  if (all(is.na(y_raw))) next
  y_ratio <- make_ratio(y_raw)
  if (length(y_ratio) < h + 1) next
  y_center <- mean(y_ratio, na.rm = TRUE)
  y_scale <- sd(y_ratio, na.rm = TRUE)
  if (is.na(y_scale) || y_scale == 0) next
  y <- (y_ratio - y_center) / y_scale
  if (any(is.na(y))) next

  test_idx <- (length(y) - h + 1):length(y)
  obs_idx <- setdiff(seq_along(y), test_idx)

  ar_fit0 <- forecast::auto.arima(y[obs_idx], max.q = 0, D = 0, seasonal = FALSE,
                                  allowmean = FALSE, allowdrift = FALSE)
  p_use <- max(1, ar_fit0$arma[1])
  ar_fit <- forecast::Arima(y[obs_idx], order = c(p_use, 0, 0), include.mean = FALSE)
  ar_fc <- forecast::forecast(ar_fit, h = length(test_idx))
  ar_pred <- as.numeric(ar_fc$mean)

  arx_fit <- forecast::Arima(y[obs_idx], order = c(p_use, 0, 0),
                             xreg = unrate_vec[obs_idx], include.mean = FALSE)
  arx_fc <- forecast::forecast(arx_fit, h = length(test_idx), xreg = unrate_vec[test_idx])
  arx_pred <- as.numeric(arx_fc$mean)

  strong_idx <- safe_select(y, X_m, obs_idx)
  if (length(strong_idx) == 0) strong_idx <- colnames(X_m)[1]
  llm_pred <- LLM_TS.Predict(X_m, y, tilde_y_m, p_use, 1, obs_idx, test_idx, strong_idx, h)

  time_llm_pred <- read_nf_pred(col_name, h, "TimeLLM")
  patch_pred <- read_nf_pred(col_name, h, "PatchTST")
  time_llm_metrics <- read_nf_metrics(col_name, h, "TimeLLM")
  patch_metrics <- read_nf_metrics(col_name, h, "PatchTST")

  pred_ok <- function(pred) {
    !is.null(pred) && is.numeric(pred) && length(pred) == length(test_idx)
  }
  mse <- function(pred) {
    if (!pred_ok(pred)) return(NA_real_)
    mean((pred - y[test_idx])^2, na.rm = TRUE)
  }
  mse_or_metric <- function(pred, metric_val) {
    val <- mse(pred)
    if (is.na(val)) metric_val else val
  }

  wins <- wins + as.integer(mse(llm_pred) < mse(ar_pred))
  total <- total + 1

  results[[length(results) + 1]] <- data.frame(
    Index = col_name,
    AR = mse(ar_pred),
    `AR+Unem` = mse(arx_pred),
    `LLM-TS` = mse(llm_pred),
    TimeLLM = mse_or_metric(time_llm_pred, time_llm_metrics$rmse),
    PatchTST = mse_or_metric(patch_pred, patch_metrics$rmse),
    `Selected topics` = paste(strong_idx, collapse = ";"),
    check.names = FALSE
  )
}

if (length(results)) {
  out <- do.call(rbind, results)
  cat("LLM-TS beats AR on MSE for", wins, "/", total, "targets (", round(wins / total * 100, 2), "%).\\n\\n")
  mse_df <- out %>%
    select(Index, AR, `AR+Unem`, `LLM-TS`, TimeLLM, PatchTST, `Selected topics`)
  mse_df
} else {
  data.frame()
}
```

## Ratio Tables

```{r}
if (exists("out") && nrow(out) > 0) {
  rMSE <- out %>%
    mutate(
      `AR+Unem` = .data[["AR+Unem"]] / .data[["AR"]],
      `LLM-TS` = .data[["LLM-TS"]] / .data[["AR"]],
      TimeLLM = .data[["TimeLLM"]] / .data[["AR"]],
      PatchTST = .data[["PatchTST"]] / .data[["AR"]]
    ) %>%
    select(Index, `AR+Unem`, `LLM-TS`, TimeLLM, PatchTST)

  count_ge1 <- function(df) {
    data.frame(
      Method = names(df)[names(df) != "Index"],
      Count = sapply(df[names(df) != "Index"], function(x) sum(x >= 1, na.rm = TRUE)),
      stringsAsFactors = FALSE
    )
  }
  rMSE_ge <- count_ge1(rMSE)
} else {
  rMSE <- data.frame()
  rMSE_ge <- data.frame()
}
```

### rMSE (relative to AR)

```{r}
knitr::kable(rMSE, digits = 4)
```

### rMSE >= 1 Count

```{r}
knitr::kable(rMSE_ge)
```

## Selected Topic Frequency

```{r}
if (exists("out") && nrow(out) > 0) {
  sel_col <- if ("Selected.topics" %in% names(out)) "Selected.topics" else "Selected topics"
  topic_counts <- out %>%
    mutate(sel = strsplit(.data[[sel_col]], ";")) %>%
    tidyr::unnest(sel) %>%
    filter(sel != "") %>%
    count(sel)

  p <- ggplot(topic_counts, aes(x = sel, y = n)) +
    geom_col(fill = "#4D92DF") +
    labs(x = "Topic", y = "Frequency", title = "Selected Topic Frequency") +
    theme_minimal(base_size = 11) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

  ggsave("final_MSE_selected_topics.pdf", p, width = 7, height = 4, dpi = 300)
  p
}
```
